<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PIP-0004: Stablised difficulty algorithm | PascalCoin Documentation</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/assets/css/0.styles.6709f360.css" as="style"><link rel="preload" href="/assets/js/app.bf5ae417.js" as="script"><link rel="preload" href="/assets/js/12.decd3bee.js" as="script"><link rel="prefetch" href="/assets/js/10.5247218d.js"><link rel="prefetch" href="/assets/js/11.0e00e471.js"><link rel="prefetch" href="/assets/js/13.4c5cdee6.js"><link rel="prefetch" href="/assets/js/14.d3750069.js"><link rel="prefetch" href="/assets/js/15.af5c43f5.js"><link rel="prefetch" href="/assets/js/16.c160d406.js"><link rel="prefetch" href="/assets/js/2.f7b51860.js"><link rel="prefetch" href="/assets/js/3.fe79fcef.js"><link rel="prefetch" href="/assets/js/4.ac8690fe.js"><link rel="prefetch" href="/assets/js/5.7bdf0bcc.js"><link rel="prefetch" href="/assets/js/6.bb38653d.js"><link rel="prefetch" href="/assets/js/7.17504fab.js"><link rel="prefetch" href="/assets/js/8.b4c05cc1.js"><link rel="prefetch" href="/assets/js/9.d855e5c0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6709f360.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">PascalCoin Documentation</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/guide/" class="nav-link">Guides</a></div><div class="nav-item"><a href="/pips/" class="nav-link router-link-active">PIPS</a></div> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/guide/" class="nav-link">Guides</a></div><div class="nav-item"><a href="/pips/" class="nav-link router-link-active">PIPS</a></div> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Pascal Improvement Proposals</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pips/PIP-0001.html" class="sidebar-link">PIP-1: PIP Purpose and Guidelines</a></li><li><a href="/pips/PIP-0002.html" class="sidebar-link">PIP-0002: In-protocol PASA Exchange</a></li><li><a href="/pips/PIP-0003.html" class="sidebar-link">PIP-0003: Infinite Scaling via Deletable Blockchain</a></li><li><a href="/pips/PIP-0004.html" class="sidebar-link">PIP-0004: Account Names and Types</a></li><li><a href="/pips/PIP-0005.html" class="active sidebar-link">PIP-0004: Stablised difficulty algorithm</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pips/PIP-0005.html#summary" class="sidebar-link">Summary</a></li><li class="sidebar-sub-header"><a href="/pips/PIP-0005.html#motivation" class="sidebar-link">Motivation</a></li><li class="sidebar-sub-header"><a href="/pips/PIP-0005.html#specification" class="sidebar-link">Specification</a></li><li class="sidebar-sub-header"><a href="/pips/PIP-0005.html#rationale" class="sidebar-link">Rationale</a></li><li class="sidebar-sub-header"><a href="/pips/PIP-0005.html#backwards-compatibility" class="sidebar-link">Backwards Compatibility</a></li><li class="sidebar-sub-header"><a href="/pips/PIP-0005.html#reference-implementation" class="sidebar-link">Reference Implementation</a></li><li class="sidebar-sub-header"><a href="/pips/PIP-0005.html#links" class="sidebar-link">Links</a></li></ul></li><li><a href="/pips/PIP-0006.html" class="sidebar-link">PIP-0006: Salvage orphaned transactions</a></li><li><a href="/pips/PIP-0007.html" class="sidebar-link">PIP-0007: New Wallet GUI</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="pip-0004-stablised-difficulty-algorithm"><a href="#pip-0004-stablised-difficulty-algorithm" aria-hidden="true" class="header-anchor">#</a> PIP-0004: Stablised difficulty algorithm</h1> <pre>  PIP: 5
  Title: Stablised difficulty algorithm
  Type: Protocol 
  Impact: Hard-Fork
  Author: Albert Molina <i>&lt;bpascalblockchain@gmail.com&gt;</i>
  Comments-URI: N/A
  Status: Active
  Created: 2017-04-01
</pre> <p><em><strong>PIP Editor Note:</strong> This PIP was created retrospectively based of the <a href="https://github.com/PascalCoin/PascalCoin/blob/master/PascalCoinWhitePaperV2.pdf" target="_blank" rel="noopener noreferrer">Whitepaper V2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> on 2017-08-15.</em>*</p> <h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <p>A new difficulty adjustment algorithm is proposed to stablise sinusoidal volatility resulting from chaotic hashpower fluctuations.</p> <h2 id="motivation"><a href="#motivation" aria-hidden="true" class="header-anchor">#</a> Motivation</h2> <p>Due to the volatile nature of cryptocurrency valuations, miners will tend to migrate en masse based on profitability of coins. As miners migrate, blocktimes are temporarily affected as time is needed for difficulty adjustments. Cloud-mining has exacerbated this issue. Resolving this issue will result in more stable blocktime and more reliable daily supply.</p> <h2 id="specification"><a href="#specification" aria-hidden="true" class="header-anchor">#</a> Specification</h2> <p>An enhanced the difficulty calculation algorithm to to better adjust
for sinusoidal volatility is proposed as follows.</p> <div class="language-pascal extra-class"><pre class="language-pascal"><code><span class="token keyword">function</span> TPCSafeBox<span class="token punctuation">.</span>GetActualTargetHash<span class="token punctuation">(</span>UseProtocolV2 <span class="token punctuation">:</span> Boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> TRawBytes<span class="token punctuation">;</span>
<span class="token comment">{ Target is calculated in each block with avg obtained in previous
  CT_CalcNewDifficulty blocks.
  If Block is lower than CT_CalcNewDifficulty then is calculated
  with all previous blocks.
}</span>
<span class="token keyword">Var</span> ts1<span class="token punctuation">,</span> ts2<span class="token punctuation">,</span> tsTeorical<span class="token punctuation">,</span> tsReal<span class="token punctuation">,</span> tsTeoricalStop<span class="token punctuation">,</span> tsRealStop<span class="token punctuation">:</span> Int64<span class="token punctuation">;</span>
  CalcBack <span class="token punctuation">:</span> Integer<span class="token punctuation">;</span>
  lastBlock <span class="token punctuation">:</span> TOperationBlock<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>BlocksCount <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token keyword">begin</span>
    <span class="token comment">// Important: CT_MinCompactTarget is applied for blocks 0 until ((CT_CalcNewDifficulty*2)-1)</span>
    <span class="token keyword">Result</span> <span class="token operator">:=</span> TPascalCoinProtocol<span class="token punctuation">.</span>TargetFromCompact<span class="token punctuation">(</span>CT_MinCompactTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>
    <span class="token keyword">if</span> BlocksCount <span class="token operator">&gt;</span> CT_CalcNewTargetBlocksAverage <span class="token keyword">then</span> CalcBack <span class="token operator">:=</span> CT_CalcNewTargetBlocksAverage
    <span class="token keyword">else</span> CalcBack <span class="token operator">:=</span> BlocksCount<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    lastBlock <span class="token operator">:=</span> Block<span class="token punctuation">(</span>BlocksCount<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>blockchainInfo<span class="token punctuation">;</span>
    <span class="token comment">// Calc new target!</span>
    ts1 <span class="token operator">:=</span> lastBlock<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
    ts2 <span class="token operator">:=</span> Block<span class="token punctuation">(</span>BlocksCount<span class="token operator">-</span>CalcBack<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>blockchainInfo<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
    tsTeorical <span class="token operator">:=</span> <span class="token punctuation">(</span>CalcBack <span class="token operator">*</span> CT_NewLineSecondsAvg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tsReal <span class="token operator">:=</span> <span class="token punctuation">(</span>ts1 <span class="token operator">-</span> ts2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">If</span> <span class="token punctuation">(</span>Not UseProtocolV2<span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token keyword">begin</span>
      <span class="token keyword">Result</span> <span class="token operator">:=</span> TPascalCoinProtocol<span class="token punctuation">.</span>GetNewTarget<span class="token punctuation">(</span>tsTeorical<span class="token punctuation">,</span> tsReal<span class="token punctuation">,</span>TPascalCoinProtocol<span class="token punctuation">.</span>TargetFromCompact<span class="token punctuation">(</span>lastBlock<span class="token punctuation">.</span>compact_target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>
      CalcBack <span class="token operator">:=</span> CalcBack DIV CT_CalcNewTargetLimitChange_SPLIT<span class="token punctuation">;</span>
      <span class="token keyword">If</span> CalcBack<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> CalcBack <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      ts2 <span class="token operator">:=</span> Block<span class="token punctuation">(</span>BlocksCount<span class="token operator">-</span>CalcBack<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>blockchainInfo<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
      tsTeoricalStop <span class="token operator">:=</span> <span class="token punctuation">(</span>CalcBack <span class="token operator">*</span> CT_NewLineSecondsAvg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      tsRealStop <span class="token operator">:=</span> <span class="token punctuation">(</span>ts1 <span class="token operator">-</span> ts2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">{ Protocol 2 change:
        Only will increase/decrease Target if (CT_CalcNewTargetBlocksAverage DIV 10) needs to increase/decrease too, othewise use
        current Target.
        This will prevent sinusoidal movement and provide more stable hashrate, computing always time from CT_CalcNewTargetBlocksAverage }</span>
      <span class="token keyword">If</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tsTeorical<span class="token operator">&gt;</span>tsReal<span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span>tsTeoricalStop<span class="token operator">&gt;</span>tsRealStop<span class="token punctuation">)</span><span class="token punctuation">)</span>
         Or
         <span class="token punctuation">(</span><span class="token punctuation">(</span>tsTeorical<span class="token operator">&lt;</span>tsReal<span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span>tsTeoricalStop<span class="token operator">&lt;</span>tsRealStop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token keyword">begin</span>
        <span class="token keyword">Result</span> <span class="token operator">:=</span> TPascalCoinProtocol<span class="token punctuation">.</span>GetNewTarget<span class="token punctuation">(</span>tsTeorical<span class="token punctuation">,</span> tsReal<span class="token punctuation">,</span>TPascalCoinProtocol<span class="token punctuation">.</span>TargetFromCompact<span class="token punctuation">(</span>lastBlock<span class="token punctuation">.</span>compact_target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>
        <span class="token comment">// Nothing to do!</span>
        <span class="token keyword">Result</span><span class="token operator">:=</span>TPascalCoinProtocol<span class="token punctuation">.</span>TargetFromCompact<span class="token punctuation">(</span>lastBlock<span class="token punctuation">.</span>compact_target<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">end</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span><span class="token punctuation">;</span>
  <span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>       
</code></pre></div><h2 id="rationale"><a href="#rationale" aria-hidden="true" class="header-anchor">#</a> Rationale</h2> <p>Solution space for this problem is vast. Rational for proposal is &quot;most simple&quot; thus less likely to introduce new attack vectors.</p> <h2 id="backwards-compatibility"><a href="#backwards-compatibility" aria-hidden="true" class="header-anchor">#</a> Backwards Compatibility</h2> <p>Proposed changes are not backwards compatible and will require a hard-fork.</p> <h2 id="reference-implementation"><a href="#reference-implementation" aria-hidden="true" class="header-anchor">#</a> Reference Implementation</h2> <p>This PIP has been implemented in V2 by Albert Molina.</p> <h2 id="links"><a href="#links" aria-hidden="true" class="header-anchor">#</a> Links</h2> <ol><li><a href="https://github.com/PascalCoin/PascalCoin/blob/master/PascalCoinWhitePaperV2.pdf" target="_blank" rel="noopener noreferrer">PascalCoin White Paper V2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/vuejs/vuepress/edit/master/docs/pips/PIP-0005.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pips/PIP-0004.html" class="prev">
          PIP-0004: Account Names and Types
        </a></span> <span class="next"><a href="/pips/PIP-0006.html">
          PIP-0006: Salvage orphaned transactions
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.bf5ae417.js" defer></script><script src="/assets/js/12.decd3bee.js" defer></script>
  </body>
</html>
